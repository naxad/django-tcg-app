{% extends "home/base.html" %}
{% block title %}Staff · Orders{% endblock %}
{% block content %}
<div class="container mt-5">
  <h2 class="mb-3">Orders (staff)</h2>

  <form class="row g-2 align-items-end mb-3">
    <div class="col-md-3">
      <label class="form-label">Search</label>
      <input type="text" class="form-control" name="q" value="{{ current.q }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Status</label>
      <select name="status" class="form-select">
        <option value="">Any</option>
        {% for k,v in statuses %}
          <option value="{{ k }}" {% if current.status == k %}selected{% endif %}>{{ v }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Fulfillment</label>
      <select name="fulfillment" class="form-select">
        <option value="">Any</option>
        {% for k,v in fulfill_choices %}
          <option value="{{ k }}" {% if current.fulfillment == k %}selected{% endif %}>{{ v }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Gateway</label>
      <select name="gateway" class="form-select">
        <option value="">Any</option>
        <option value="stripe" {% if current.gateway == 'stripe' %}selected{% endif %}>Stripe</option>
        <option value="paypal" {% if current.gateway == 'paypal' %}selected{% endif %}>PayPal</option>
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Paid</label>
      <select name="paid" class="form-select">
        <option value="">Any</option>
        <option value="yes" {% if current.paid == 'yes' %}selected{% endif %}>Yes</option>
        <option value="no"  {% if current.paid == 'no'  %}selected{% endif %}>No</option>
      </select>
    </div>
    <div class="col-md-1 d-grid">
      <button class="btn btn-primary">Filter</button>
    </div>
  </form>

  <div class="d-flex justify-content-between mb-2">
    <div class="text-muted">Showing {{ page.start_index }}–{{ page.end_index }} of {{ page.paginator.count }}</div>
    <a class="btn btn-sm btn-outline-secondary" href="{% url 'backoffice:orders_export_csv' %}?{{ request.GET.urlencode }}">Export CSV</a>
  </div>

  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th>ID</th><th>Created</th><th>User / Email</th>
            <th>Total</th><th>Status</th><th>Fulfillment</th><th>Gateway</th><th></th>
          </tr>
        </thead>
        <tbody>
        {% for o in page %}
          <tr>
            <td>#{{ o.id }}</td>
            <td>{{ o.created_at|date:"Y-m-d H:i" }}</td>
            <td>
              {% if o.user %}{{ o.user.username }}<br>{% endif %}
              <span class="text-muted small">{{ o.email }}</span>
            </td>
            <td>€{{ o.total }}</td>
            <td>
              {% if o.status == 'paid' %}
                <span class="badge bg-success">Paid</span>
              {% elif o.status == 'pending' %}
                <span class="badge bg-warning text-dark">Pending</span>
              {% elif o.status == 'failed' %}
                <span class="badge bg-danger">Failed</span>
              {% else %}
                <span class="badge bg-secondary">{{ o.status|title }}</span>
              {% endif %}
            </td>
            <td>
              {% if o.fulfillment_status %}
                <span class="badge bg-info text-dark">{{ o.get_fulfillment_status_display }}</span>
              {% else %}
                <span class="text-muted">—</span>
              {% endif %}
            </td>
            <td class="text-muted small">{{ o.gateway|default:"—" }}</td>
            <td class="text-end">
              <a class="btn btn-sm btn-outline-primary" href="{% url 'backoffice:order_detail' o.id %}">View</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="8" class="text-center text-muted py-4">No orders match your filters.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  {% if page.paginator.num_pages > 1 %}
  <nav class="mt-3">
    <ul class="pagination justify-content-center">
      {% if page.has_previous %}
        <li class="page-item"><a class="page-link" href="?page={{ page.previous_page_number }}&{{ request.GET.urlencode }}">Previous</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Previous</span></li>
      {% endif %}
      <li class="page-item disabled"><span class="page-link">Page {{ page.number }} of {{ page.paginator.num_pages }}</span></li>
      {% if page.has_next %}
        <li class="page-item"><a class="page-link" href="?page={{ page.next_page_number }}&{{ request.GET.urlencode }}">Next</a></li>
      {% else %}
        <li class="page-item disabled"><span class="page-link">Next</span></li>
      {% endif %}
    </ul>
  </nav>
  {% endif %}
</div>
{% endblock %}
